<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>AUTh-ARL Core Stack: Installing a real-time kernel</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AUTh-ARL Core Stack
   &#160;<span id="projectnumber">0.7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('real_time.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Installing a real-time kernel </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="install"></a>
Installing the kernel</h1>
<p>Instructions for installing a real-time kernel for Ubuntu 16.04.</p>
<p>First install Ubuntu 16.04 in your machine.</p>
<dl class="section warning"><dt>Warning</dt><dd>The following instructions assume root access.</dd></dl>
<p>First download the kernel and the patch </p>
<pre class="fragment">mkdir -p /usr/src/kernels
cd /usr/src/kernels
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.11.12.tar.gz
sudo tar -xf linux-4.11.12.tar.gz
mv linux-4.11.12 ./linux-4.11.12-rt16
cd linux-4.11.12-rt16
wget https://mirrors.edge.kernel.org/pub/linux/kernel/projects/rt/4.11/patch-4.11.12-rt16.patch.gz
gzip -d patch-4.11.12-rt16.patch.gz
sudo gzip -d patch-4.11.12-rt16.patch.gz
patch -p1 &lt;patch-4.11.12-rt16.patch
</pre><p>Configure the kernel: </p>
<pre class="fragment">make menuconfig
</pre><p>If this fails (with an error 'curses.h' missing) install the following: </p>
<pre class="fragment">sudo apt-get install libncurses5-dev
</pre><p>In the configuration set: <code>Processor type and Features &gt; Preemption Model (Fully Preemptible Kernel (RT)) &gt; (Fully Preemptible Kernel (RT))</code></p>
<p>Then build the kernel: </p>
<pre class="fragment">make
make modules_install install
</pre><p>Reboot and select the new kernel.</p>
<p>In order to show the grub during booting press shift or edit <code>/etc/default/grub</code> file and place a <code>#</code> symbol at the start of line <code>GRUB_HIDDEN_TIMEOUT=0</code>.</p>
<p>Then update grub: </p>
<pre class="fragment">update-grub
reboot
</pre><p>The instructions were based on this <a class="el" href="citelist.html#CITEREF_rt">[6]</a>.</p>
<h2><a class="anchor" id="default-kernel"></a>
Set the kernel as default</h2>
<p>In order to set kernel as the default follow these instructions taken from here <a class="el" href="citelist.html#CITEREF_default-kernel">[1]</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>The following instructions assume root access.</dd></dl>
<p>First changed the GRUB_DEFAULT to ‘saved’ in <code>/etc/default/grub</code> by: </p>
<pre class="fragment">cp /etc/default/grub /etc/default/grub.bak
vim /etc/default/grub
...
GRUB_DEFAULT=saved
...
</pre><p>Now create a backup of the grub config for recovery purposes if needed, then rebuild grub: </p>
<pre class="fragment">cp /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
update-grub
</pre><p>Determine what the full kernel name is you want to use. Get the listing by running: </p>
<pre class="fragment">egrep "^[[:space:]]?(submenu|menuentry)" /boot/grub/grub.cfg | cut -d "'" -f2
</pre><p>Result: </p>
<pre class="fragment">Ubuntu
Advanced options for Ubuntu
Ubuntu, with Linux 4.4.0-78-generic
Ubuntu, with Linux 4.4.0-78-generic (recovery mode)
Ubuntu, with Linux 4.4.0-47-generic
Ubuntu, with Linux 4.4.0-47-generic (recovery mode)
Ubuntu, with Linux 4.11.12-rt16
Ubuntu, with Linux 4.11.12-rt16 (recovery mode)
</pre><p>Use the <code>linux-4.11.12-rt16</code> kernel. Setting that to be the default kernel is simple. However, you MUST prepend ‘Advanced options for Ubuntu’ to the kernel name as shown below since Ubuntu makes use of sub menus in the kernel listing. So set the desired kernel by running: </p>
<pre class="fragment">grub-set-default 'Advanced options for Ubuntu&gt;Ubuntu, with Linux 4.11.12-rt16'
</pre><p>Now verify that the change got applied in the configs by running: </p>
<pre class="fragment">grub-editenv list
</pre><p>Result: </p>
<pre class="fragment">saved_entry=Advanced options for Ubuntu&gt;Ubuntu, with Linux 4.11.12-rt16
</pre><p>Reboot the system so it boots off the older kernel: </p>
<pre class="fragment">reboot
</pre><p>Finally, once the system comes back online, verify the desired kernel is running by: </p>
<pre class="fragment">uname -r
4.11.12-rt16
</pre><p>If the system rebooted, and dropped you into a grub shell with an error, you can boot up off of the backup grub.cfg file that was created by: </p>
<pre class="fragment"> grub2&gt; configfile (hd0,1)/boot/grub2/grub.cfg.bak
</pre><h1><a class="anchor" id="test"></a>
Test the RT kernel</h1>
<p>The kernel version must now contain the tags <code>PREEMPT</code> and <code>RT</code> such as </p>
<pre class="fragment">uname -v
#42 SMP PREEMPT RT Fri Nov 6 18:55:29 CET 2009
</pre><p>or something went completely wrong, otherwise.</p>
<p>Also you can use the following tool to test that the kernel has real-time capabilities:</p>
<dl class="section warning"><dt>Warning</dt><dd>The following instructions assume root access.</dd></dl>
<p>Download and build the testing tool </p>
<pre class="fragment">git clone git://git.kernel.org/pub/scm/linux/kernel/git/clrkwllms/rt-tests.git
cd rt-tests
make
</pre><p>If this fails you may need to install the following and make again: </p>
<pre class="fragment">sudo apt-get install libnuma-dev
</pre><p>Run: </p>
<pre class="fragment">./cyclictest -a -t -n -p99
</pre><p>And in another terminal stress the CPU </p>
<pre class="fragment">stress --cpu 1000
</pre><p>On a non-realtime system, you may see something like </p>
<pre class="fragment">T: 0 ( 3431) P:99 I:1000 C: 100000 Min:      5 Act:   10 Avg:   14 Max:   39242
T: 1 ( 3432) P:98 I:1500 C:  66934 Min:      4 Act:   10 Avg:   17 Max:   39661
</pre><p>The rightmost column contains the most important result, i.e. the worst-case latency of 39.242 milliseconds. On a realtime-enabled system, the result may look like </p>
<pre class="fragment">T: 0 ( 3407) P:99 I:1000 C: 100000 Min:      7 Act:   10 Avg:   10 Max:      18
T: 1 ( 3408) P:98 I:1500 C:  67043 Min:      7 Act:    8 Avg:   10 Max:      22
</pre><p>and, thus, indicate an apparent short-term worst-case latency of 18 microseconds.</p>
<p>More info here: <a class="el" href="citelist.html#CITEREF_rt-test">[5]</a>.</p>
<h1><a class="anchor" id="machine-lwr"></a>
Machine Configuration for running KUKA LWR4+</h1>
<p>In order to run KUKA LWR4+ with our interfaces (which use FRILibrary, ROS etc) you need to to provide your user name with real time priority and memlock limits higher than the default ones <a class="el" href="citelist.html#CITEREF_kuka-piaggio-readme">[3]</a>. You can do it permanently like this: </p>
<pre class="fragment">sudo nano /etc/security/limits.conf
</pre><p>and add these lines: </p>
<pre class="fragment">YOUR_USERNAME hard rtprio 99
YOUR_USERNAME soft rtprio 99
YOUR_USERNAME hard memlock unlimited
YOUR_USERNAME soft memlock unlimited
</pre><p>Then, </p>
<pre class="fragment">sudo nano /etc/pam.d/common-session
</pre><p>and add </p>
<pre class="fragment">session required pam_limits.so
</pre><p>Reboot, open a terminal, and check that <code>ulimit -r -l</code> gives you the values set above.</p>
<p>Finally you can run the gravity compensation example from Core examples to test the above. </p>
<pre class="fragment">roslaunch autharl_description display.launch config:=lwr
rosrun autharl_examples_lwr gravity_compensation_example  # in another terminal</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Fri Mar 23 2018 22:16:11 for AUTh-ARL Core Stack by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
